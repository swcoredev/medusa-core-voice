"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.runMigrationScripts = runMigrationScripts;
const framework_1 = require("@medusajs/framework");
const links_1 = require("@medusajs/framework/links");
const migrations_1 = require("@medusajs/framework/migrations");
const utils_1 = require("@medusajs/framework/utils");
const path_1 = require("path");
const modules_sdk_1 = require("@medusajs/framework/modules-sdk");
const loaders_1 = require("../../loaders");
const utils_2 = require("../utils");
const TERMINAL_SIZE = process.stdout.columns;
/**
 * A low-level utility to migrate the migration scripts. This util should
 * never exit the process implicitly.
 */
async function runMigrationScripts({ directory, container, logger, }) {
    let onApplicationPrepareShutdown = async () => Promise.resolve();
    let onApplicationShutdown = async () => Promise.resolve();
    let plugins;
    try {
        await (0, utils_2.ensureDbExists)(container);
        const configModule = container.resolve(utils_1.ContainerRegistrationKeys.CONFIG_MODULE);
        plugins = await (0, utils_1.getResolvedPlugins)(directory, configModule, true);
        (0, utils_1.mergePluginModules)(configModule, plugins);
        const resources = await loadResources(plugins, logger);
        onApplicationPrepareShutdown = resources.onApplicationPrepareShutdown;
        onApplicationShutdown = resources.onApplicationShutdown;
        const scriptsSourcePaths = [
            (0, path_1.join)((0, path_1.dirname)(require.resolve("@medusajs/medusa")), "migration-scripts"),
            ...plugins.map((plugin) => (0, path_1.join)(plugin.resolve, "migration-scripts")),
        ];
        const migrator = new migrations_1.MigrationScriptsMigrator({ container: container });
        await migrator.ensureMigrationsTable();
        const pendingScripts = await migrator.getPendingMigrations(scriptsSourcePaths);
        if (!pendingScripts?.length) {
            logger.info("No pending migration scripts to execute");
            return true;
        }
        logger.log(new Array(TERMINAL_SIZE).join("-"));
        logger.info("Pending migration scripts to execute");
        logger.info(`${pendingScripts.join("\n")}`);
        logger.log(new Array(TERMINAL_SIZE).join("-"));
        logger.info("Running migration scripts...");
        await migrator.run(scriptsSourcePaths);
        logger.log(new Array(TERMINAL_SIZE).join("-"));
        logger.info("Migration scripts completed");
        return true;
    }
    finally {
        await onApplicationPrepareShutdown();
        await onApplicationShutdown();
    }
}
async function loadResources(plugins, logger) {
    /**
     * Clear all module instances to prevent cache from kicking in
     */
    modules_sdk_1.MedusaModule.clearInstances();
    /**
     * Setup
     */
    const linksSourcePaths = plugins.map((plugin) => (0, path_1.join)(plugin.resolve, "links"));
    await new links_1.LinkLoader(linksSourcePaths, logger).load();
    const medusaAppResources = await new framework_1.MedusaAppLoader().load();
    const onApplicationPrepareShutdown = medusaAppResources.onApplicationPrepareShutdown;
    const onApplicationShutdown = medusaAppResources.onApplicationShutdown;
    await medusaAppResources.onApplicationStart();
    return {
        onApplicationPrepareShutdown,
        onApplicationShutdown,
    };
}
const main = async function ({ directory, }) {
    const container = await (0, loaders_1.initializeContainer)(directory);
    const logger = container.resolve(utils_1.ContainerRegistrationKeys.LOGGER);
    try {
        const migrated = await runMigrationScripts({
            directory,
            container: container,
            logger,
        });
        process.exit(migrated ? 0 : 1);
    }
    catch (error) {
        logger.error(error);
        process.exit(1);
    }
};
exports.default = main;
//# sourceMappingURL=run-scripts.js.map